name: RepliChain CI/CD

on:
  push:
    branches:
      - main

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3Ô∏è‚É£ Build backend & frontend containers
      - name: Build Docker images
        run: |
          docker build -t replichain-backend -f docker/Dockerfile.backend .
          docker build -t replichain-frontend -f docker/Dockerfile.frontend .

      # 4Ô∏è‚É£ Health check for backend
      - name: Health check backend
        run: |
          echo "Running backend container health check..."
          docker run -d --name backend replichain-backend
          sleep 5
          if ! docker logs backend | grep -q "Server running"; then
            echo "‚ùå Deployment failed ‚Äî rolling back..."
            exit 1
          fi
          echo "‚úÖ Backend is healthy"

      # 5Ô∏è‚É£ Mark version as stable if build passed
      - name: Tag stable version
        if: success()
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag -f stable
          git push origin stable --force
          echo "‚úÖ Stable version tagged"

      # 6Ô∏è‚É£ Rollback if build fails
      - name: Rollback to stable version
        if: failure()
        run: |
          git fetch origin stable
          git reset --hard stable
          echo "üîÅ Rolled back to last stable version"
