name: RepliChain CI/CD

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build_and_test:
    runs-on: ubuntu-latest

    steps:
      # Step 1 â€” Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2 â€” Set up Docker Buildx (for multi-platform build support)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Step 3 â€” Build Docker images for backend and frontend
      - name: Build Docker images
        run: |
          echo "ğŸš€ Building Docker images..."
          docker build -t docker-backend -f docker/Dockerfile.backend .
          docker build -t docker-frontend -f docker/Dockerfile.frontend .

      # Step 4 â€” Run backend container and perform health check
      - name: Health check backend
        run: |
          echo "ğŸ©º Running backend health check..."
          docker run -d -p 5000:5000 docker-backend
          sleep 5
          curl -f http://localhost:5000 || exit 1
          echo "âœ… Backend is healthy!"

      # Step 5 â€” Tag as stable version if build succeeds
      - name: Tag stable version
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ·ï¸ Tagging current commit as stable..."
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag -f stable
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }} stable --force
          echo "âœ… Deployment marked as stable"

      # Step 6 â€” Rollback to stable version if build fails
      - name: Rollback to stable version
        if: failure()
        run: |
          echo "âš ï¸ Deployment failed â€” rolling back to last stable version..."
          git fetch --all --tags
          git checkout tags/stable -f
          echo "âœ… Rolled back to stable version successfully!"

      # Step 7 â€” Cleanup (optional)
      - name: Clean up Docker containers
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up containers..."
          docker ps -q | xargs -r docker stop
          docker system prune -f
          echo "ğŸ§¼ Cleanup complete!"
